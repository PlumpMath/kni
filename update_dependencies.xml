<project name="KNI update dependencies" default="all">
    <property name="lib" location="${basedir}/lib"/>
    <property name="dependencies" location="${basedir}/dependencies"/>
    <property name="download" location="${dependencies}/download"/>

    <target name="init">
        <mkdir dir="${lib}"/>
        <mkdir dir="${download}"/>
    </target>

    <target name="libffi">
        <!-- TODO: update to newer libffi -->

        <get src="https://codeload.github.com/atgreen/libffi/zip/v3.0.13"
             dest="${download}/libffi-3.0.13.zip"
             usetimestamp="true"/>

        <property name="ffi.src" location="${dependencies}/libffi-build"/>
        <delete dir="${ffi.src}"/>
        <mkdir dir="${ffi.src}"/>

        <!-- Invoking native unzip instead of Ant task because the latter doesn't set correct file permissions -->
        <!-- TODO: check availability of external utilities (unzip, tar, libtool, ...) beforehand -->
        <exec executable="/usr/bin/unzip" output="/dev/null" failonerror="true">
            <arg value="${download}/libffi-3.0.13.zip"/>
            <arg value="-d"/>
            <arg value="${ffi.src}"/>
        </exec>

        <move todir="${ffi.src}">
            <fileset dir="${ffi.src}/libffi-3.0.13"/>
        </move>

        <exec dir="${ffi.src}" executable="/bin/sh" failonerror="true">
            <env key="CC" value="/usr/bin/cc"/>
            <env key="CFLAGS" value="-O2 -arch i386 -arch x86_64"/>
            <env key="LDFLAGS" value="-arch i386 -arch x86_64"/>
            <arg value="configure"/>
            <arg value="--enable-debug"/>
            <arg value="--disable-dependency-tracking"/>
            <arg value="--enable-static"/>
            <arg value="--disable-shared"/>
            <arg value="--with-pic=yes"/>
        </exec>

        <exec dir="${ffi.src}" executable="/usr/bin/make" failonerror="true"/>

        <pathconvert property="ffi.target">
            <dirset dir="${ffi.src}" includes="x86_64-*"/>
        </pathconvert>

        <delete dir="${lib}/libffi"/>
        <mkdir dir="${lib}/libffi"/>

        <exec dir="${ffi.target}/.libs" executable="/usr/bin/libtool" failonerror="true">
            <arg value="-static"/>
            <arg value="-o"/>
            <arg value="${lib}/libffi/libffi.dylib"/>
            <arg value="libffi.a"/>
        </exec>

        <copy todir="${lib}/libffi">
            <fileset dir="${ffi.target}/include" includes="**/*.h"/>
        </copy>
    </target>

    <target name="update">
        <!-- Kotlin -->

        <get src="https://teamcity.jetbrains.com/guestAuth/repository/download/bt345/bootstrap.tcbuildtag/kotlin-compiler-{build.number}.zip"
             dest="${download}/kotlin-compiler.zip"
             usetimestamp="true"/>
        <delete dir="${lib}/kotlinc"/>
        <exec executable="/usr/bin/unzip" output="/dev/null" failonerror="true">
            <arg value="${download}/kotlin-compiler.zip"/>
            <arg value="-d"/>
            <arg value="${lib}"/>
        </exec>

        <!-- JUnit -->

        <get src="http://repository.jetbrains.com/remote-repos/junit/junit/4.10/junit-4.10.jar"
             dest="${download}/junit-4.10.jar"
             usetimestamp="true"/>
        <copy file="${download}/junit-4.10.jar" todir="${lib}"/>

        <!-- Protocol Buffers -->

        <get src="https://protobuf.googlecode.com/svn/rc/protobuf-2.6.0.zip"
             dest="${download}/protobuf-2.6.0.zip"
             usetimestamp="true"/>

        <delete dir="${lib}/google"/>
        <unzip src="${download}/protobuf-2.6.0.zip" dest="${lib}">
            <patternset>
                <include name="protobuf-2.6.0/src/google/protobuf/**/*.h"/>
            </patternset>
            <cutdirsmapper dirs="2"/>
        </unzip>

        <get src="http://repository.jetbrains.com/remote-repos/com/google/protobuf/protobuf-java/2.6.0/protobuf-java-2.6.0.jar"
             dest="${download}/protobuf-2.6.0.jar"
             usetimestamp="true"/>
        <copy file="${download}/protobuf-2.6.0.jar" todir="${lib}"/>

        <get src="http://repository.jetbrains.com/remote-repos/com/google/protobuf/protobuf-java/2.6.0/protobuf-java-2.6.0-sources.jar"
             dest="${download}/protobuf-2.6.0-sources.jar"
             usetimestamp="true"/>
        <copy file="${download}/protobuf-2.6.0-sources.jar" todir="${lib}"/>

        <!-- Clang -->

        <get src="http://llvm.org/releases/3.5.0/cfe-3.5.0.src.tar.xz"
             dest="${download}/cfe-3.5.0.src.tar.xz"
             usetimestamp="true"/>

        <!-- Ant 'untar' task doesn't support 'xz' compression format -->
        <exec dir="${download}" executable="/usr/bin/tar" failonerror="true">
            <arg line="xf cfe-3.5.0.src.tar.xz --strip-components 2 cfe-3.5.0.src/include/clang-c"/>
        </exec>

        <delete dir="${lib}/clang-c"/>
        <move file="${download}/clang-c" todir="${lib}"/>
    </target>

    <target name="all" depends="init,libffi,update"/>
</project>
