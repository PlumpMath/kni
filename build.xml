<project name="KNI" default="dist">
    <property name="output" location="${basedir}/dist"/>
    <property name="lib" location="${basedir}/lib"/>
    <property name="kotlinc" location="${lib}/kotlinc"/>

    <typedef resource="org/jetbrains/jet/buildtools/ant/antlib.xml"
             classpath="${kotlinc}/lib/kotlin-ant.jar"/>

    <target name="clean">
        <delete dir="${output}"/>
    </target>

    <target name="init">
        <mkdir dir="${output}"/>
        <mkdir dir="${output}/build"/>
    </target>

    <macrodef name="protoc-indexer">
        <attribute name="output"/>

        <sequential>
            <mkdir dir="@{output}/native"/>
            <mkdir dir="@{output}/src"/>
            <exec executable="${lib}/protobuf/bin/protoc" failonerror="true">
                <arg value="--cpp_out=@{output}/native"/>
                <arg value="--java_out=@{output}/src"/>
                <arg value="--proto_path=${basedir}/indexer"/>
                <arg value="${basedir}/indexer/NativeIndex.proto"/>
            </exec>
        </sequential>
    </macrodef>

    <target name="protoc">
        <protoc-indexer output="${basedir}/indexer"/>
    </target>

    <target name="indexer">
        <protoc-indexer output="${output}/build/indexer/proto"/>

        <fail message="Files generated by protoc have changed. Run 'ant protoc' manually">
            <condition>
                <not>
                    <filesmatch file1="${output}/build/indexer/proto/native/NativeIndex.pb.cc"
                                file2="${basedir}/indexer/native/NativeIndex.pb.cc"/>
                </not>
            </condition>
        </fail>

        <exec dir="${basedir}/indexer/native" executable="/usr/bin/make" failonerror="true">
            <arg value="clean"/>
            <arg value="test"/>
        </exec>
    </target>

    <target name="runtime-objc">
        <property name="runtime-objc" location="${output}/build/runtime-objc"/>

        <delete dir="${runtime-objc}"/>
        <mkdir dir="${runtime-objc}"/>
        <javac srcdir="${basedir}/runtime-objc/src" destdir="${runtime-objc}"
               includeantruntime="false" source="1.6" target="1.6">
            <withKotlin/>
            <classpath location="${kotlinc}/lib/kotlin-runtime.jar"/>
        </javac>

        <!-- TODO: improve workflow somehow when .h changes -->
        <javah verbose="true" outputfile="${basedir}/runtime-objc/native/kniobjc.h">
            <class name="kni.objc.Native"/>
            <classpath>
                <pathelement location="${runtime-objc}"/>
                <pathelement location="${kotlinc}/lib/kotlin-runtime.jar"/>
            </classpath>
        </javah>

        <property name="java.include" location="${java.home}/../include"/>
        <exec executable="/usr/bin/c++" failonerror="true">
            <arg line="-O2 -Wall -Wl,-no_compact_unwind"/>
            <arg value="-I${java.include}"/>
            <arg value="-I${java.include}/darwin"/>
            <arg value="-I${lib}/libffi"/>
            <!-- TODO: statically link libffi instead of using path to library here -->
            <arg value="-L${lib}/libffi"/>
            <arg line="-lffi -lobjc -dynamiclib"/>
            <arg value="-o"/>
            <arg value="${runtime-objc}/libKNIObjCRuntime.dylib"/>
            <arg value="${basedir}/runtime-objc/native/kniobjc.cc"/>
        </exec>

        <jar jarfile="${output}/kni-objc-runtime.jar">
            <fileset dir="${runtime-objc}">
                <include name="**/*.class"/>
                <include name="**/*.dylib"/>
            </fileset>

            <manifest>
                <attribute name="Built-By" value="JetBrains"/>
                <attribute name="Implementation-Vendor" value="JetBrains"/>
                <attribute name="Implementation-Title" value="KNI Objective-C Runtime"/>
                <attribute name="Implementation-Version" value="0.1-SNAPSHOT"/>
            </manifest>
        </jar>
    </target>

    <target name="dist" depends="clean,init,indexer,runtime-objc"/>
</project>
